<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Saint John's Cemetery in Darien Veteran Database - Veteran Management">
    <title>Veteran Management - Saint John's Cemetery in Darien</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">Saint John's Cemetery in Darien</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="dashboard.html">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="veteranstorage.html">Veterans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logoutBtn">Logout</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Search and Add Section -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search veterans...">
                    <button class="btn btn-primary" type="button" id="searchBtn">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addVeteranModal">
                    <i class="bi bi-plus-circle"></i> Add Veteran
                </button>
            </div>
        </div>

        <!-- Veterans Table -->
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Service Branch</th>
                                <th>Service Dates</th>
                                <th>Birth Date</th>
                                <th>Death Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="veteransTable">
                            <!-- Veteran rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Veteran Modal -->
    <div class="modal fade" id="addVeteranModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Veteran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addVeteranForm">
                        <div class="mb-3">
                            <label class="form-label">Full Name</label>
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Service Branch</label>
                            <select class="form-select" name="serviceBranch" required>
                                <option value="">Select Branch</option>
                                <option value="Army">Army</option>
                                <option value="Navy">Navy</option>
                                <option value="Marines">Marines</option>
                                <option value="Air Force">Air Force</option>
                                <option value="Coast Guard">Coast Guard</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Service Start Date</label>
                                <input type="date" class="form-control" name="serviceStartDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Service End Date</label>
                                <input type="date" class="form-control" name="serviceEndDate" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Birth Date</label>
                                <input type="date" class="form-control" name="birthDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Death Date</label>
                                <input type="date" class="form-control" name="deathDate" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Additional Notes</label>
                            <textarea class="form-control" name="notes" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveVeteranBtn">Save Veteran</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Veteran Modal -->
    <div class="modal fade" id="editVeteranModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Veteran</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editVeteranForm">
                        <input type="hidden" name="id">
                        <!-- Same form fields as add veteran form -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="updateVeteranBtn">Update Veteran</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { auth } from './firebase.js';
        import { createVeteran, getVeterans, updateVeteran, deleteVeteran, searchVeterans } from './crude.js';

        // Check authentication
        auth.onAuthStateChanged((user) => {
            if (!user) {
                window.location.href = 'login.html';
            }
        });

        // Handle logout
        document.getElementById('logoutBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            try {
                await auth.signOut();
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Error signing out:', error);
            }
        });

        // Load veterans
        async function loadVeterans() {
            try {
                const veterans = await getVeterans();
                const tableBody = document.getElementById('veteransTable');
                tableBody.innerHTML = veterans.map(veteran => `
                    <tr>
                        <td>${veteran.name}</td>
                        <td>${veteran.serviceBranch}</td>
                        <td>${new Date(veteran.serviceStartDate).toLocaleDateString()} - ${new Date(veteran.serviceEndDate).toLocaleDateString()}</td>
                        <td>${new Date(veteran.birthDate).toLocaleDateString()}</td>
                        <td>${new Date(veteran.deathDate).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editVeteran('${veteran.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteVeteran('${veteran.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error loading veterans:', error);
            }
        }

        // Add veteran
        document.getElementById('saveVeteranBtn').addEventListener('click', async () => {
            const form = document.getElementById('addVeteranForm');
            const formData = new FormData(form);
            const veteranData = Object.fromEntries(formData.entries());

            try {
                await createVeteran(veteranData);
                bootstrap.Modal.getInstance(document.getElementById('addVeteranModal')).hide();
                form.reset();
                loadVeterans();
            } catch (error) {
                console.error('Error adding veteran:', error);
            }
        });

        // Search veterans
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const searchTerm = document.getElementById('searchInput').value;
            try {
                const veterans = await searchVeterans(searchTerm);
                const tableBody = document.getElementById('veteransTable');
                tableBody.innerHTML = veterans.map(veteran => `
                    <tr>
                        <td>${veteran.name}</td>
                        <td>${veteran.serviceBranch}</td>
                        <td>${new Date(veteran.serviceStartDate).toLocaleDateString()} - ${new Date(veteran.serviceEndDate).toLocaleDateString()}</td>
                        <td>${new Date(veteran.birthDate).toLocaleDateString()}</td>
                        <td>${new Date(veteran.deathDate).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="editVeteran('${veteran.id}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteVeteran('${veteran.id}')">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            } catch (error) {
                console.error('Error searching veterans:', error);
            }
        });

        // Make functions available globally
        window.editVeteran = async (id) => {
            const veteran = (await getVeterans()).find(v => v.id === id);
            if (veteran) {
                const form = document.getElementById('editVeteranForm');
                form.id.value = veteran.id;
                Object.keys(veteran).forEach(key => {
                    const input = form.elements[key];
                    if (input) {
                        input.value = veteran[key];
                    }
                });
                new bootstrap.Modal(document.getElementById('editVeteranModal')).show();
            }
        };

        window.deleteVeteran = async (id) => {
            if (confirm('Are you sure you want to delete this veteran?')) {
                try {
                    await deleteVeteran(id);
                    loadVeterans();
                } catch (error) {
                    console.error('Error deleting veteran:', error);
                }
            }
        };

        // Update veteran
        document.getElementById('updateVeteranBtn').addEventListener('click', async () => {
            const form = document.getElementById('editVeteranForm');
            const formData = new FormData(form);
            const veteranData = Object.fromEntries(formData.entries());
            const id = veteranData.id;
            delete veteranData.id;

            try {
                await updateVeteran(id, veteranData);
                bootstrap.Modal.getInstance(document.getElementById('editVeteranModal')).hide();
                loadVeterans();
            } catch (error) {
                console.error('Error updating veteran:', error);
            }
        });

        // Initial load
        loadVeterans();
    </script>
</body>
</html>
